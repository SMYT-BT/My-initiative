# lecture06:講義概要
## 概要
AWSの維持・運用に必要な意識の一つとして、コスト管理が求められる。 
監視サービスの紹介を切り口に不適切な高コストパフォーマンスを検知するためのアラート機能やロギングサービスを学習。
本講義で取り上げられた各サービスはAWS運用の基本でありクラウドエンジニアとしての必要認識を再確認するものであった。

## 【システムの安定稼働】
- システムはその役目をおえるまで安定して稼働し続けることが重要であり、このシステムの中にはインフラも含まれます。

## 【証跡・ログについて】  
システム内のさまざまな処理が「すべて正常に行われていること」「異常処理がないこと」をログ（記録）から知る必要がある。

## ○証跡
- 明確にわかるよう保管しておかないといけないもの
- 「証拠となる痕跡」を指し、いわゆるログの中でも「システムの外・中を問わない予期せぬ（または不正な）アクセスの証拠となり得るもの」を指す。

### ●CloudTrail
証跡の確保を実施。ほぼすべての AWS イベントを記録しており、あとで紹介する監視の情報源にできる他、不正アクセス調査などにも利用する。
ただしアプリケーションの証跡を確保するわけではない（たとえばアプリ利用者のログイン履歴は載らない）

### ●Config
- 各種リソースの変更履歴を保管するサービス。
- EC2 インスタンス、セキュリティグループといった単位で変更のタイムラインを見ることができる

※CloudTrail にも「何の変更を指示したかと、その結果」は記録されているが、検索性が悪い為、代わりに Config を使う。

### ●VPC フローログ
VPC 内の通信ログを取るサービス。具体的には EC2 や RDS に接続（アタッチ）された ENI（仮想ネットワークインターフェイス）の通信ログを取得している。

- フローログには、ENI に流れた通信のさまざまな情報が載っている。  
→通信元、宛先  
→通信のプロトコル、ポート  
→正しく到達したか、遮断されたか、etc  

- VPCを作ったら有効化するべきサービス。
- セキュリティグループの設定漏れチェックには、真っ先に本サービスを有効化する。
- 問題が発生してから有効化しても、ログが取れず証跡を追うことはできない。
- 保存先を CloudWatch Logs と S3 で選択が可能であるが、基本的に前者で（7日保管くらい）で事足りる。
- PCI DSS など、何らかのセキュリティ基準で長期保管したい場合は S3 を選択する。

※ネットワークインターフェイスとは
サーバーでは、有線 LAN、または光ファイバーケーブルを直接繋げるカードを追加することが珍しくない。このカードが「ネットワークインターフェイス」。
EC2 ではこれを仮想化したものを、1 つ以上取り付けて利用している。

### ●CloudWatch Logs
- 監視系のサービス CloudWatch の機能の 1 つで、主に「OS 領域が触れない AWS サービス」のログを格納してくれる。
- 「OS は管理したくない、でもログだけは見たい」というニーズを満たすサービス。
- 設定は必要なもののOS 内のログを受け取って蓄えることも可能です。
- ログを蓄えるだけではなく、このログデータをアラームの条件にも使う事ができる。
- RDS から取得できるログはエンジン別に異なる


## ○監視
- システムの振る舞い、出力を観察してチェックする事をいう。簡単に言えば「正常な時を観察」して、その情報を元に「異常をチェック」すること。
その際、異常のイベントを元に、関係者に知らせたり、自動で復旧の為のアクションを関連付けるということが必要になる。

### ●CloudWatch
監視のデータソース（情報源）として利用できる。

- CloudWatch メトリクス
・メトリクス：各種 AWS サービスで事前定義された、監視に使える指標のデータ
※いわゆるニアリアルタイム（ほぼリアルタイム）の観測データ。現在の情報を知らせるものに過ぎない
EC2 の主要なメトリクス。CPU 使用率などを拾うことができる。メトリクスには標準とカスタムがあり、カスタムは有料。  
RDSにも多くのメトリクスが提供されている。

- CloudWatch アラーム
メトリクスに対して閾値やアクションの設定ができる。
※閾値：エラーと判断するパーセンテージやカウント数のこと
※アクション：閾値を超えたとき、または下回ったときに実行する処理のこと。

【例】「ALB 配下のインスタンスが異常になったら知らせてほしい」というニーズに対して
・対象およびメトリクス：ALB/ UnhealtyHostCount
・閾値およびアクション：300 秒あたりに 1 以上/E メール通知（Amazon SNS を利用）

- CloudWatch logs メトリクスフィルター
・「CloudWatch Logs がアラームの条件に使える」ようにする。  
・たとえば Logs に貯まったログから文字列を拾ってカウントし、それをアラーム対象とすることもできる。  
・アプリケーションが格納したログも対応している。  
※RDS の場合は簡単な設定で logs へログが出力されるため、たとえば root ログインしたときにアラーム発報し、メール通知することもできる。


## ○通知
### ●EventBridge
・AWS サービスで発生したイベントを他の AWS サービスと繋げる。  
・イベントはただ記録するだけではなく、処理のトリガーとして使うこともできる。  
・アクションには、CloudWatch アラームと同じようなサービスが指定できるため、E メールで管理者に知らせることも可能。  
・AWS サービス間を繋げるサービスであるため、別の AWS の処理を開始するということも可能（連携先が対応しているなど条件あり）。

## ○コスト管理
- 「ムダなリソースをそのままにしておかない」というのは基本原則
- これから作るリソースのコストが事前に試算（＝見積）できること
- 現在のコストと、将来のコストを可視化できていること
- 会社またはプロジェクトで割り当てた予算を意識できること

### ●Calculator
- AWS pricing calculatorは、AWS 利用料の見積が可能なツール。
- 各種サービスのスペック、予定しているトラフィックなどを指定すると見積が出る。さらに見積した結果は共有することが可能。
- 表示が英語だが、右上の English を日本語に変えれば日本語で見積できる。  

### ●Billing
- AWS の利用料、請求を管理できるサービス。支払いのクレジットカード変更などもここで行える。
- 初期状態では IAM ユーザーから見ることができない。
- AWS 内の利用料関連サービスはすべて Billing の権限が必要なため、まずはルートユーザー上で許可を行う必要がある。

### ●Cost Explorer
AWS の利用料が把握できるツール。現在の利用料を積み上げグラフで確認できたり、表示データをフィルターすることが可能。

※コスト配分タグ
タグ付けすることでどのサービスにどれくらい料金が発生しているか表示させる。
【例】
コスト配分タグを Application という名前で定義しておき、EC2 の A と B にそれぞれ Application=hoge 、 Application=fuga と付けておけば、システムごとの利用料を表示することが可能。

### ●Budget
予算を管理することに特化したサービス。会社やプロジェクト、財布の状況に応じた予算を設定しておくと、現在の推移で予算を超えそうかどうかを予測する。
予算超過の未然防止に役立てられます。

### ●Cost Anomaly Detection
コストの異常変動を AI で検知するサービス。無料で利用できます。
※基本的には Bugdets などで予算管理していくのがセオリー
「稼働させているサービスが非常に多く、個別の管理人員は割けない。異常に料金が上がっているリソースは把握したい」というケースに有効。

# 課題_ログ監視の証跡と課金の確認
## [1/5] CroudTrailにてAWS最終利用記録を確認

### ●SNSメールの確認手順

- ALBのターゲットグループ内のEC2つの稼働を確認 
- Webアプリケーション側のUnicornを起動。Healty状態になったことを確認し、Unicornを落とす 
- ヘルスチェックがUnhealtyになったことを確認 

下記画像にて「2022/09/24 (土) 13:22」にメールが来たことを確認。

![](https://github.com/SMYT-BT/My-initiative/blob/main/OnlineSchool_Raisetech/Raisetech%E8%AA%B2%E9%A1%8C/lecture06/Picts/%E8%AA%B2%E9%A1%8C6-1.png)

## [2/5] ALBをCloudwatchでHealthCheck監視を実施

- ALBにサブスクリプションを定義する

![](https://github.com/SMYT-BT/My-initiative/blob/main/OnlineSchool_Raisetech/Raisetech%E8%AA%B2%E9%A1%8C/lecture06/Picts/%E8%AA%B2%E9%A1%8C6-2_ALB%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3.png)

- Unhealtyを発生させ、SNSでメールが受信されるか確認する。

![](https://github.com/SMYT-BT/My-initiative/blob/main/OnlineSchool_Raisetech/Raisetech%E8%AA%B2%E9%A1%8C/lecture06/Picts/%E8%AA%B2%E9%A1%8C6-2.png)

- メッセージの受信を確認
![](https://github.com/SMYT-BT/My-initiative/blob/main/OnlineSchool_Raisetech/Raisetech%E8%AA%B2%E9%A1%8C/lecture06/Picts/%E8%AA%B2%E9%A1%8C6-2_ALB%E3%83%A1%E3%83%BC%E3%83%AB.png)

## [3/5] AWSの利用料の見積もりを作成

※AWSコンソール内に見積もりを提示するサービスがなかったため、月次の使用料を記載した情報を提示。 
（AWS Pricing Calculatorというコンソール外のサービスを確認したが、正確な情報を提示できないと感じ上記対応を実施）

![](https://github.com/SMYT-BT/My-initiative/blob/main/OnlineSchool_Raisetech/Raisetech%E8%AA%B2%E9%A1%8C/lecture06/Picts/%E8%AA%B2%E9%A1%8C6-3.png)

## [4/5] 先月の請求情報から利用料を確認

![](https://github.com/SMYT-BT/My-initiative/blob/main/OnlineSchool_Raisetech/Raisetech%E8%AA%B2%E9%A1%8C/lecture06/Picts/%E8%AA%B2%E9%A1%8C6-4.png)

## [5/5] 今月の利用料、またFree Tier枠内で収まっているか確認

![](https://github.com/SMYT-BT/My-initiative/blob/main/OnlineSchool_Raisetech/Raisetech%E8%AA%B2%E9%A1%8C/lecture06/Picts/%E8%AA%B2%E9%A1%8C6-5.png)
