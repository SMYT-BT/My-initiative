# lecture07
## 【概要】
AWS上を問わず一般的なセキュリティ施策として、想定される被害に始まり、脆弱性ポイントの各部にスポットを当てて講義を進める。  
FWを実現するサービスを活用することはもちろんであるが、自分たちが何に対して（今回はWebアプリケーション）施策を立てようとしているのか、理解が求められる。いわば既存サービスのウィークポイントを把握したのちに、適切なサービスを選択することが最も望ましい。
加え、失念しがちな認証周りについても言及する講義である。

## ○セキュリティ
- セキュリティに必要なもの 
・セキュリティリスクへの理解 
・セキュリティ対策を決めること 

- 基本原則 
・想定されるリスクを洗い出す
・リスクに対しての以下対応方針（アクション）を定義する 

→受容：そのままでよいと判断した場合、そのまま受け入れ、対策を行わない 
→低減：影響を減らすような対策を行う 
→移転（転嫁）：AWS側の対処など切り分けリスクの管理を当事者以外に委任する 
→回避：リスク自体を発生させないようにする

### 【想定されるリスク】
- 脆弱性：バグや設定不備によるシステムの「弱点、穴」を指す。
- 認証情報の流出：IAMアクセスキーの流出など定期的に発生するものに対する。
- 人為的な過負荷：多数のコンピューターから連続でリクエストを送り、停止に追いやられます

### 【セキュリティ対策計画の主体】
セキュリティインシデントが発生した場合に最終責任を取るのは事業責任者。

理想論は、
「事業責任者が全体をコントロールして、想定リスクを洗い出し、対策についてはエンジニアという専門家の知見を借りること」

残念ながら丸投げされることは避けられないため、基本的には
「すべてのリスクを洗い出すのは不可能（増えるものだから）」
「最終判断は事業責任者である」という相手へのインプット・合意を忘れずに。


## ○脆弱性対策
「アプリケーション」「OS、ミドルウェア」「ネットワーク、その他」が中心である。

### アプリケーション
- アプリケーションコード、もしくは機能追加のために使っているモジュール、ライブラリ。
- 基本的にコードは GitHub で管理されており、その際に Dependabotという「モジュール、ライブラリの更新を指摘してくれる Bot」が使われている。  
※Java と Python を用いた開発の場合は、 AWS でも脆弱性を無くすためのサービスが提供されている。
- Web アプリケーションは元々ベースにしている技術が原因による脆弱性がある。AWS でもDDoSなど脆弱性に対する攻撃をマネージドサービ
スを使って攻撃から防護することが可能。

#### ●CodeGuru Reviewer
- Amazon CodeGuru の機能のひとつ
- AI を用いて GitHub などのリポジトリにあるコードをスキャンし、改善を提案してくれる
- ただし料金は 10 万行コードごとに 10 ドルと、それなりにかかる

#### 【Webアプリケーションの脆弱性】
- Web アプリケーションは元々 Web サイトの為に作られた技術をアプリケーションに転用したもの。そのため仕組み上抱えている脆弱性がある。
- Web アプリケーションの攻撃手法と対策方法について、OWASP という非営利団体が「とくに重大な 10 個」について「OWASP Top 10」としてまとめている。  
※日本の OWASP 団体でも最新のOWASP Top 10 を日本語で公開している。  

- 「実際に対策を行うにはどうすれば良いのか？」ですが、対策のひとつとして WAF（WebApplication Firewall）という仕組みが存在する。

#### ●AWS WAF
- AWS が提供する WAF サービスで、従来は専用装置で導入が必要だったものを仮想化し、導入障壁を下げたもの。
- AWS WAF ではルールを新規作成するか、 AWS やパートナーが提供するルールを使える。
- ルールをELB または CloudFrontに設置することで、クライアントのアクセスを必ず WAF が評価するようになる。


#### ●AWS Managed Rules Common Rule Set
- この中でOWASP Top 10 がサポートされている。基本的にこのルールグループの利用を前提とすることが AWS の推奨事項。
- ルールには WCU という「コスト」が設定されており、合計 1500 までしかルールを設定できない。
- AWSManagedRulesCommonRuleSet だけで 700WCU ありますが、残り半分以上はあるため不足するケースはほぼない。

### OS、ミドルウェアの脆弱性対策
OS で利用されているさまざまなプログラム、ミドルウェアも、人が作っているので脆弱性が見つかることがある。

#### ●CVSS 
- 脆弱性情報をとりまとめる共通脆弱性評価システムのこと。脆弱性に対しての重要度を設定しており、すぐ適用するかどうかの判断基準にできる。  
※日本での CVSS データベースはJVN。国外だと米国の NIST もデータベースを持っている（NVD）。

#### ●Inspector
- 脆弱性のスキャンを行うサービス。EC2 と、コンテナイメージ向けリポジトリの ECR のスキャンに対応している。
- 自動修復機能はないため、発見した後にどう対処していくかが重要。  
※脆弱性の情報源は NVD を元にしているため、重要度が一番高いものは 1 ヶ月以内にパッチを適用する、などルール付けして運用することが重要。  

※AWS には SSM Patch Manager というサービスもあり、パッチの自動化支援も提供されている。


### ネットワーク、その他の脆弱性対策
- ネットワークにおける通信の許可設定や、IAM の権限などに脆弱性が存在する。

#### Security Hub
- AWS の設定情報を検索して、脆弱な部分を指摘してくれたり、特定の業界基準に準拠しているかを確認する。
- ただし利用料がそれなりにかかる（内部で Config ルールを作って処理しているため、Config ルール料金がかかる）ため、設定画面の予想コストを見ながら使うとよい。
- 一度有効化してから結果が出るまでに 24 時間かかり、結果が出たら一度情報をダウンロードして、無効化するとコストは低く抑えられる。
- 他の AWS のセキュリティ関連サービス結果を集約できるという機能もある。


## SSL 接続
Web アプリケーションにおいて通信経路の暗号化というのは必須事項であり、利用者と Web サーバーの間で通信を誰かにのぞき見されることは必要要件に反する。  

●AWS Certificate Manager（ACM）
- SSL 証明書を発行するマネージドサービス。
- ELB や CloudFront にアタッチすることができ、利用者と AWS サービス間の通信を暗号化し、のぞき見することを防げる。

※外部公開する Web アプリケーションに使うようなパブリック証明書は無料で発行できるが、内部サービスで使うようなプライベート証明書は料金がかかる。

- ACM で発行した証明書をアタッチするだけで良いわけではない。なぜなら、 HTTP 通信の経路が開かれたままであるため。  
※ALB ならリスナールールで HTTP アクセスを HTTPS に転送するルールを追加する、CloudFront ならビューワープロトコルポリシーでHTTPS 限定にするなど、必ず HTTPS（SSL)通信をを経由するように設定が必要。

## AWSの認証情報流出について
### ●KMS（Key Management Service）
- AWS の暗号鍵マネージドサービス。
- 主に 2 つの機能があり、暗号鍵を自分で用意しなくてもよいというのが特長。
- EBS、S3 などのデータの読み書き時に自動的に暗号、復号を行う仕組み。
- AWS CLI などを用いた鍵の利用（ファイルや文字列を暗号化できる）
- KMS 鍵自体が IAM ポリシーとキーポリシー（キーに直接アタッチするポリシー）と 2 重で権限管理されているため、鍵の利用権限がないと復号ができないこと。

### ●Secrets Manager
- 秘匿しなければいけない情報を KMS で暗号化して安全に保管、呼び出しするサービス。
- 呼び出すときはシークレット名と、設定されているキー（鍵の事ではなく、S3 のときにできるキーのこと）を指定すると、バリュー（値）が返ってくる。
- 開発キット（SDK）を使って、アプリケーションコードに取り出しの仕組みを実装する。
- RDS のみ対応している機能だが、Secrets Manager では DB パスワードの定期変更ができる。

## 過負荷対策
### ●AWS Shield
- DDoS 攻撃からインフラを保護してくれるマネージドサービス。DDoS 攻撃と思われる通信を自動で遮断してくれる。
- Standard と Advanced の 2 プランある。
- Standard プランでは DDoS 攻撃の基本的な防護を行うプランで、CloudFront、Route 53、ElasticIP など、「インターネットと接する」主要なサービスをサポートしている。

### ●Shield Advanced
Standard の内容に加え、以下の内容が提供される。その代わり超高額である。
- 3000 ドル/月で 12 ヶ月縛り
- 対応サービスに ALB が追加
- DDoS 攻撃疑いがある情報の通知
- 専任チームの待機
- DDoS 攻撃が原因とされるスケール費用の免除  

基本的には Standard で事足りる。

## その他対策サービス
### ●IAM Access Analyzer
- 各種ポリシーのチェックを行い、大きな権限を与えていないかを確認する。  
※S3、IAM ロール、KMS、Lambda、SQS、Secrets Managerを対象

- ポリシーの利用履歴から、最適なポリシーの案を出してくれる。 

### ●GuardDuty
- AWS 内のイベントをチェックし、セキュリティインシデントの疑いがあるイベントについて指摘する。
- 従来はセキュリティのプロが確認していたような業務を AI に任せることで、低コストでサービスを提供してくれる。  
※指摘してくれるパターンは限られており充実しているとは言えない

- 料金も CloudTrail イベント分析が 5 ドル程度（100 万イベント）であり、このコストと被害にあったときのコストを考えると、支払うコストとしては格安。

# 課題_なし